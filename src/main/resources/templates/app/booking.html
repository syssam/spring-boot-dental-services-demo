<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
    th:replace="~{app/account-layout :: layout(
        title='Booking', 
        content='::content', 
        css='booking',
        scripts='::scripts',
        breadcrumb='::breadcrumb'
    )}"
>
      <body>
    <nav th:fragment="breadcrumb" aria-label="breadcrumb" class="page-breadcrumb">
        <div class="container-xxl">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="https://onlineshop1.codesignx.com"><i class="fa-solid fa-house"></i></a></li>
                <li class="breadcrumb-item active" aria-current="page">帳戶</li>
            </ol>
        </div>
    </nav>
    <main th:fragment="content">
        <div class="page-header d-flex justify-content-between align-items-center">
            <h1>My Booking</h1>
            <a th:href="@{/booking/create}" class="btn btn-primary">
                <i class="fas fa-plus-circle me-2"></i>新预约
            </a>
        </div>
        
        <div class="page-content">
            <!-- 预约列表标签页 -->
            <div class="card text-center">
                <div class="card-header p-0 bg-white border-0">
                    <ul class="nav nav-tabs">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="upcoming-tab" data-bs-toggle="tab" data-bs-target="#upcoming" type="button" role="tab" aria-controls="upcoming" aria-selected="true">即将到来</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="past-tab" data-bs-toggle="tab" data-bs-target="#past" type="button" role="tab" aria-controls="past" aria-selected="false">历史预约</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="cancelled-tab" data-bs-toggle="tab" data-bs-target="#cancelled" type="button" role="tab" aria-controls="cancelled" aria-selected="false">已取消</button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="appointment-tab-content">
                        <!-- 即将到来的预约 -->
                        <div class="tab-pane fade show active" id="upcoming" role="tabpanel" aria-labelledby="upcoming-tab">
                            <div th:if="${#lists.isEmpty(upcomingAppointments)}" class="text-center py-5">
                                <i class="fas fa-calendar-alt fa-3x text-muted mb-3"></i>
                                <p class="lead">您目前没有即将到来的预约</p>
                                <a th:href="@{/booking/create}" class="btn btn-outline-primary mt-2">
                                    立即预约
                                </a>
                            </div>
                            
                            <div th:if="${not #lists.isEmpty(upcomingAppointments)}">
                                <div class="row appointment-cards">
                                    <div class="col-md-6 col-lg-4 mb-4" th:each="appointment : ${upcomingAppointments}">
                                        <div class="card appointment-card h-100">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <div class="appointment-date">
                                                    <span class="date-day" th:text="${appointment.appointmentDate != null ? #temporals.format(appointment.appointmentDate, 'dd') : ''}">15</span>
                                                    <span class="date-month" th:text="${appointment.appointmentDate != null ? #temporals.format(appointment.appointmentDate, 'MMM') : ''}">Apr</span>
                                                </div>
                                                <span class="badge bg-primary" th:text="${appointment.appointmentDate != null ? #temporals.format(appointment.appointmentDate, 'EEEE') : '未知'}">Monday</span>
                                            </div>
                                            <div class="card-body">
                                                <h5 class="card-title" th:text="${appointment.treatmentType != null ? appointment.treatmentType.name : '未知治疗'}">常规检查</h5>
                                                <ul class="list-unstyled mb-3">
                                                    <li class="mb-2">
                                                        <i class="fas fa-user-md text-primary me-2"></i>
                                                        <span th:text="${appointment.dentist != null ? ('Dr. ' + appointment.dentist.firstName + ' ' + appointment.dentist.lastName) : '未知医生'}">Dr. William Lam</span>
                                                    </li>
                                                    <li class="mb-2">
                                                        <i class="fas fa-clock text-primary me-2"></i>
                                                        <span th:with="startFormatted=${appointment.startTime != null ? #temporals.format(appointment.startTime, 'HH:mm') : '未知'}, endFormatted=${appointment.endTime != null ? #temporals.format(appointment.endTime, 'HH:mm') : '未知'}" 
                                                                th:text="${startFormatted + ' - ' + endFormatted}">09:00 - 10:00</span>
                                                    </li>
                                                    <li>
                                                        <i class="fas fa-map-marker-alt text-primary me-2"></i>
                                                        <span th:text="${appointment.clinic != null ? appointment.clinic.name : '未知诊所'}">TST 诊所</span>
                                                    </li>
                                                </ul>
                                                <p class="card-text small" th:if="${appointment.notes}" th:text="${appointment.notes}">
                                                    患者备注显示在这里
                                                </p>
                                            </div>
                                            <div class="card-footer d-flex justify-content-between">
                                                <a th:href="@{/booking/view/{id}(id=${appointment.id})}" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye me-1"></i> 详情
                                                </a>
                                                <div>
                                                    <a th:href="@{/booking/edit/{id}(id=${appointment.id})}" class="btn btn-sm btn-outline-secondary me-1">
                                                        <i class="fas fa-edit me-1"></i> 改期
                                                    </a>
                                                    <button type="button" class="btn btn-sm btn-outline-danger cancel-btn" 
                                                            th:data-appointment-id="${appointment.id}" 
                                                            data-bs-toggle="modal" data-bs-target="#cancelModal">
                                                        <i class="fas fa-times-circle me-1"></i> 取消
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 历史预约 -->
                        <div class="tab-pane fade" id="past" role="tabpanel" aria-labelledby="past-tab">
                            <div th:if="${#lists.isEmpty(pastAppointments)}" class="text-center py-5">
                                <i class="fas fa-history fa-3x text-muted mb-3"></i>
                                <p class="lead">您没有历史预约记录</p>
                            </div>
                            
                            <div th:if="${not #lists.isEmpty(pastAppointments)}">
                                <div class="row appointment-cards">
                                    <div class="col-md-6 col-lg-4 mb-4" th:each="appointment : ${pastAppointments}">
                                        <div class="card appointment-card h-100">
                                            <div class="card-header d-flex justify-content-between align-items-center bg-light">
                                                <div class="appointment-date">
                                                    <span class="date-day" th:text="${appointment.appointmentDate != null ? #temporals.format(appointment.appointmentDate, 'dd') : ''}">15</span>
                                                    <span class="date-month" th:text="${appointment.appointmentDate != null ? #temporals.format(appointment.appointmentDate, 'MMM') : ''}">Apr</span>
                                                </div>
                                                <span class="badge bg-success" th:if="${appointment.status == 'COMPLETED'}">已完成</span>
                                                <span class="badge bg-warning" th:if="${appointment.status == 'NO_SHOW'}">未出席</span>
                                            </div>
                                            <div class="card-body">
                                                <h5 class="card-title" th:text="${appointment.treatmentType != null ? appointment.treatmentType.name : '未知治疗'}">常规检查</h5>
                                                <ul class="list-unstyled mb-3">
                                                    <li class="mb-2">
                                                        <i class="fas fa-user-md text-muted me-2"></i>
                                                        <span th:text="${appointment.dentist != null ? ('Dr. ' + appointment.dentist.firstName + ' ' + appointment.dentist.lastName) : '未知医生'}"></span>
                                                    </li>
                                                    <li class="mb-2">
                                                        <i class="fas fa-clock text-muted me-2"></i>
                                                        <span th:with="startFormatted=${appointment.startTime != null ? #temporals.format(appointment.startTime, 'HH:mm') : '未知'}, endFormatted=${appointment.endTime != null ? #temporals.format(appointment.endTime, 'HH:mm') : '未知'}" 
                                                                th:text="${startFormatted + ' - ' + endFormatted}"></span>
                                                    </li>
                                                    <li>
                                                        <i class="fas fa-map-marker-alt text-muted me-2"></i>
                                                        <span th:text="${appointment.clinic != null ? appointment.clinic.name : '未知诊所'}"></span>
                                                    </li>
                                                </ul>
                                            </div>
                                            <div class="card-footer">
                                                <a th:href="@{/booking/view/{id}(id=${appointment.id})}" class="btn btn-sm btn-outline-secondary w-100">
                                                    <i class="fas fa-eye me-1"></i> 查看详情
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 已取消预约 -->
                        <div class="tab-pane fade" id="cancelled" role="tabpanel" aria-labelledby="cancelled-tab">
                            <div th:if="${#lists.isEmpty(cancelledAppointments)}" class="text-center py-5">
                                <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                                <p class="lead">您没有已取消的预约</p>
                            </div>
                            
                            <div th:if="${not #lists.isEmpty(cancelledAppointments)}">
                                <div class="row appointment-cards">
                                    <div class="col-md-6 col-lg-4 mb-4" th:each="appointment : ${cancelledAppointments}">
                                        <div class="card appointment-card h-100 border-secondary">
                                            <div class="card-header d-flex justify-content-between align-items-center bg-light">
                                                <div class="appointment-date">
                                                    <span class="date-day" th:text="${appointment.appointmentDate != null ? #temporals.format(appointment.appointmentDate, 'dd') : ''}">15</span>
                                                    <span class="date-month" th:text="${appointment.appointmentDate != null ? #temporals.format(appointment.appointmentDate, 'MMM') : ''}">Apr</span>
                                                </div>
                                                <span class="badge bg-secondary">已取消</span>
                                            </div>
                                            <div class="card-body">
                                                <h5 class="card-title text-muted" th:text="${appointment.treatmentType != null ? appointment.treatmentType.name : '未知治疗'}">常规检查</h5>
                                                <ul class="list-unstyled mb-3 text-muted">
                                                    <li class="mb-2">
                                                        <i class="fas fa-user-md me-2"></i>
                                                        <span th:text="${appointment.dentist != null ? ('Dr. ' + appointment.dentist.firstName + ' ' + appointment.dentist.lastName) : '未知医生'}"></span>
                                                    </li>
                                                    <li class="mb-2">
                                                        <i class="fas fa-clock me-2"></i>
                                                        <span th:with="startFormatted=${appointment.startTime != null ? #temporals.format(appointment.startTime, 'HH:mm') : '未知'}, endFormatted=${appointment.endTime != null ? #temporals.format(appointment.endTime, 'HH:mm') : '未知'}" 
                                                                th:text="${startFormatted + ' - ' + endFormatted}"></span>
                                                    </li>
                                                    <li>
                                                        <i class="fas fa-map-marker-alt me-2"></i>
                                                        <span th:text="${appointment.clinic != null ? appointment.clinic.name : '未知诊所'}"></span>
                                                    </li>
                                                </ul>
                                                <div class="small text-muted mt-3">
                                                    <strong>取消原因:</strong>
                                                    <p th:text="${appointment.cancellationReason}">时间冲突</p>
                                                </div>
                                            </div>
                                            <div class="card-footer">
                                                <a th:href="@{/booking/create}" class="btn btn-sm btn-outline-primary w-100">
                                                    <i class="fas fa-redo me-1"></i> 重新预约
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 取消预约的模态框 -->
        <div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="cancelModalLabel">取消预约</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="cancelForm" th:action="@{/booking/cancel/}" method="post">
                        <input type="hidden" id="appointmentId" name="appointmentId" value="" />
                        <div class="modal-body">
                            <p>您确定要取消此预约吗？</p>
                            <div class="mb-3">
                                <label for="reason" class="form-label">取消原因</label>
                                <select class="form-select" id="reason" name="reason" required>
                                    <option value="">请选择取消原因</option>
                                    <option value="时间冲突，无法前往">时间冲突，无法前往</option>
                                    <option value="症状已改善，不需要就诊">症状已改善，不需要就诊</option>
                                    <option value="选择其他医生">选择其他医生</option>
                                    <option value="选择其他日期">选择其他日期</option>
                                    <option value="other">其他原因</option>
                                </select>
                            </div>
                            <div class="mb-3" id="otherReasonDiv" style="display: none;">
                                <label for="otherReason" class="form-label">请说明</label>
                                <textarea class="form-control" id="otherReason" name="otherReason" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">返回</button>
                            <button type="submit" class="btn btn-danger">确认取消</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>
    
    <!-- JavaScript 代码片段 -->
    <script th:fragment="scripts">
        $(document).ready(function() {
            // 取消预约按钮点击
            $('.cancel-btn').click(function() {
                var appointmentId = $(this).data('appointment-id');
                $('#appointmentId').val(appointmentId);
                // 动态修改表单action
                $('#cancelForm').attr('action', '/booking/cancel/' + appointmentId);
            });
            
            // 处理其他原因
            $('#reason').change(function() {
                if ($(this).val() === 'other') {
                    $('#otherReasonDiv').show();
                } else {
                    $('#otherReasonDiv').hide();
                }
            });
            
            // 表单提交前处理其他原因
            $('#cancelForm').submit(function(e) {
                if ($('#reason').val() === 'other') {
                    var otherReason = $('#otherReason').val();
                    if (otherReason.trim() === '') {
                        showErrorMessage('请说明取消原因');
                        return false;
                    }
                }
                return true;
            });
        });
    </script>
</body>
</html>
